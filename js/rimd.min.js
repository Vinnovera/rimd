!function(e,t){"use strict";"function"==typeof define&&define.amd?define([],t()):"object"==typeof exports?module.exports=t():e.Rimd=t()}(this,function(){"use strict";function e(e){function s(){for(var e,t=/\{([\s\S]+?)\}/g,n="";null!==(e=t.exec(L.path));)n+="|\\{"+e[1]+"\\}";return new RegExp(n.substr(1),"g")}function u(e){for(var n=c(e),r=e.length,i=0;r>i;i++)T.push(t(e[i],n[i],L.lazyload,L.centerImage)),R.push(e[i]),N.push(n[i])}function l(e){var t,n,r=e.src.split("?");return e.path=r[0],n=L.path.replace(y,function(t,n,r){return d(e,t,n,r)}),r.length>1&&(t=r[1],n+=m?"&"+t:"?"+t),e.path=n,n}function d(e,t){var n;switch(t){case"{width}":return n=g(L.widths,e.offsetWidth)*(L.dubbleSizeRetina&&o?2:1),e.width=n,n;case"{height}":return n=g(L.heights,e.offsetHeight)*(L.dubbleSizeRetina&&o?2:1),e.height=n,n;case"{retina}":return o?1:0;default:return n=t.substr(1,t.length-2),n in e?e[n]:""}}function c(e){for(var t,n,r=[],i=e.length,a=0,o={};i>a;a++)if(r[a]={},r[a].offsetWidth=e[a].offsetWidth,r[a].offsetHeight=e[a].offsetHeight,t=e[a].getElementsByTagName("noscript")[0]){o=t.dataset?t.dataset:f(t);for(n in o)r[a][n]=o[n];r[a].path=l(r[a])}return r}function f(e){var t,n,r,i={},a=0;if("undefined"==typeof e||!("attributes"in e))return i;for(t=e.attributes,n=t.length;n>a;a++)/^data-/.test(t[a].name)&&(r=t[a].name.substr(5).replace(/-(.)/g),i[r]=t[a].value);return i}function p(e){var t=[];return e=e.replace(/[.]/,""),t=a.querySelectorAll?a.querySelectorAll("."+e):h(e)}function h(e){var t,n=[],r=a.getElementsByTagName("*");for(t in r)(" "+r[t].className+" ").indexOf(" "+e+" ")>-1&&n.push(r[t]);return n}function g(e,t){var n,r,i,a,o=0;if(!e)return t;for(n=e.length,a=e[n-1];n>o;o++){if(i=e[o]-t,L.closestAbove){if(0>i)continue}else i=0>i?~i:i;(void 0===r||r>i)&&(r=i,a=e[o])}return a}function v(){var e=0,t=T.length;for(L.reloadOnResize&&i.removeEventListener("resize",w);t>e;e++)T[e].destruct();T=null,R=null,N=null}var m,y,E,w,b,L={},z={nodeList:[],className:"rimd",widths:["320","600","1024"],heights:["320","600","1024"],path:"resimage/?image={path}&w={width}",reloadOnResize:!1,lazyload:!1,closestAbove:!1,centerImage:!1,dubbleSizeRetina:!1},T=[],R=[],N=[];return L=n(z,e),m=L.path.split("?").length>1,y=s(),E=L.nodeList.length?L.nodeList:p(L.className),u(E),E=null,L.reloadOnResize&&(w=r(function(){for(var e=c(R),t=0,n=R.length;n>t;t++)N[t].path!==l(e[t])&&T[t].updateImage(e[t]);N=e}),i.addEventListener("resize",w)),b={destruct:v,options:L,update:w,addImages:u}}function t(e,t,n,o){function s(t){t.path&&(c&&c.parentNode&&c.parentNode.removeChild(c),c=a.createElement("img"),c.src=t.path,t.alt&&(c.alt=t.alt),t.title&&(c.title=t.title),o&&(t.width&&(c.style.left="50%",c.style.marginLeft=-t.width/2+"px"),t.height&&(c.style.top="50%",c.style.marginTop=-t.height/2+"px")),!n||u(e)?e.appendChild(c):(l(),i.addEventListener("scroll",f),i.addEventListener("resize",p)))}function u(e){var t=e.dataset&&e.dataset.top?e.dataset.top:e.getBoundingClientRect().top,n=a.documentElement,r=t<=(i.pageYOffset||n.scrollTop)-(n.clientTop||0)+(i.innerHeight||n.clientHeight);return r||!e.dataset||e.dataset.top||(e.dataset.top=t),r}function l(){i.removeEventListener("scroll",f),i.removeEventListener("resize",p)}function d(){l(),c&&c.parentNode&&c.parentNode.removeChild(c),c=null}var c,f=r(function(){u(e)&&(e.appendChild(c),l())}),p=r(function(){"undefined"!=typeof e.dataset&&(e.dataset.top=e.getBoundingClientRect().top),f()});return s(t),{removeListeners:l,updateImage:s,destruct:d}}function n(e,t){for(var n in t)t.hasOwnProperty(n)&&"undefined"!=typeof t[n]&&(e[n]=t[n]);return e}function r(e,t,n){var r,i=0,a=null,o=function(){i=(new Date).getTime(),e.apply(n,r),n=r=null};return t=t||17,function(){var e=(new Date).getTime(),s=t-(e-i);r=arguments,n=n||this,i&&(0>=s||s>t)?(a&&(clearTimeout(a),a=null),o()):i?(clearTimeout(a),a=setTimeout(o,s)):o()}}if(!window)return!1;var i=window,a=document,o=i.devicePixelRatio>1;return i.addEventListener||!function(e,t,n,r,i,a,o){e[r]=t[r]=n[r]=function(e,t){var n=this;o.unshift([n,e,t,function(e){e.currentTarget=n,e.preventDefault=function(){e.returnValue=!1},e.stopPropagation=function(){e.cancelBubble=!0},e.target=e.srcElement||n,t.call(n,e)}]),this.attachEvent("on"+e,o[0][3])},e[i]=t[i]=n[i]=function(e,t){var n,r=0;for(r;n==o[r];++r)if(n[0]==this&&n[1]==e&&n[2]==t)return this.detachEvent("on"+e,o.splice(r,1)[0][3])},e[a]=t[a]=n[a]=function(e){return this.fireEvent("on"+e.type,e)}}(Window.prototype,HTMLDocument.prototype,Element.prototype,"addEventListener","removeEventListener","dispatchEvent",[]),e});